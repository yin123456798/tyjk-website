<html lang="zh-CN">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   个人中心 - 天涯极客社团
  </title>
  <script src="https://res.gemcoder.com/js/reload.js">
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <script src="./supabase-config.js"></script>
  <script>
   tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#165DFF',
        secondary: '#6B7280',
        accent: '#3B82F6',
        light: '#F3F4F6',
        dark: '#1F2937',
        success: '#10B981',
        warning: '#F59E0B',
        danger: '#EF4444',
        'red-600': '#DC2626',
        'blue-600': '#2563EB',
        'green-600': '#16A34A',
        'purple-600': '#9333EA'
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif']
      }
    }
  }
};
  </script>
  <style type="text/tailwindcss">
   @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .form-input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary transition duration-200;
            }
            .btn-primary {
                @apply bg-primary text-white py-2 px-4 rounded-md hover:bg-primary/90 transition duration-200 shadow-sm hover:shadow;
            }
            .btn-secondary {
                @apply bg-white text-primary border border-primary py-2 px-4 rounded-md hover:bg-primary/5 transition duration-200;
            }
            .card-shadow {
                @apply shadow-md hover:shadow-lg transition-shadow duration-300;
            }
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .glass-effect {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.9);
            }
        }
  </style>
 </head>
 <body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 font-sans text-dark min-h-screen">
  <!-- 顶部导航栏 -->
  <header class="glass-effect shadow-sm sticky top-0 z-10 border-b border-white/20">
   <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
     <div class="flex items-center">
      <a href="./index.html" class="text-xl font-bold text-primary flex items-center">
       <i class="fas fa-users mr-2"></i>
       天涯极客社团
      </a>
     </div>
     <div class="flex items-center space-x-4">
      <span id="user-name" class="text-secondary font-medium">用户名</span>
      <button class="text-secondary hover:text-primary transition-colors duration-200 flex items-center bg-white/50 px-3 py-1 rounded-full" id="logoutBtn">
       <i class="fas fa-sign-out-alt mr-2">
       </i>
       退出
      </button>
     </div>
    </div>
   </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
   <div class="max-w-7xl mx-auto">
    <!-- 页面标题 -->
    <div class="mb-8 text-center">
     <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-dark mb-4">
      个人中心
     </h1>
     <p class="text-secondary text-lg max-w-2xl mx-auto">
      管理您的个人信息、社团活动和项目参与
     </p>
    </div>

    <!-- 主要内容区域 -->
    <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
      
      <!-- 左侧边栏 - 用户信息和快捷操作 -->
      <div class="xl:col-span-1 space-y-6">
        
        <!-- 用户信息卡片 -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 card-shadow border border-white/20">
          <div class="flex flex-col items-center text-center">
            <div class="relative mb-4">
              <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-lg">
                <img alt="用户头像" class="w-full h-full object-cover" id="avatarPreview" src="https://design.gemcoder.com/staticResource/echoAiSystemImages/6d889aef6e47f91e119c162f932286b6.png"/>
              </div>
              <label class="absolute -bottom-1 -right-1 bg-primary text-white rounded-full p-2 cursor-pointer shadow-md hover:bg-primary/90 transition-colors duration-200" for="avatarUpload">
                <i class="fas fa-camera text-sm"></i>
                <input accept="image/*" class="hidden" id="avatarUpload" type="file"/>
              </label>
            </div>
            <h3 class="text-lg font-semibold mb-1" id="userName">未设置</h3>
            <p class="text-secondary text-sm mb-4" id="userInfo">点击编辑完善个人信息</p>
            
            <!-- 用户状态指示器 -->
            <div class="w-full bg-gray-100 rounded-full h-2 mb-2">
              <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full" style="width: 60%"></div>
            </div>
            <p class="text-xs text-secondary">信息完整度 60%</p>
          </div>
        </div>

        <!-- 快捷操作卡片 -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 card-shadow border border-white/20">
          <h2 class="text-lg font-semibold mb-4 flex items-center text-primary">
            <i class="fas fa-bolt mr-2"></i>
            快捷操作
          </h2>
          <div class="space-y-3">
            <a class="block w-full btn-secondary flex items-center justify-center py-3 rounded-lg" href="./index.html">
              <i class="fas fa-home mr-2"></i>
              返回首页
            </a>
            <a class="block w-full btn-secondary flex items-center justify-center py-3 rounded-lg" href="./index.html#join">
              <i class="fas fa-edit mr-2"></i>
              提交报名
            </a>
            <a class="block w-full btn-primary flex items-center justify-center py-3 rounded-lg" href="./project-management.html">
              <i class="fas fa-project-diagram mr-2"></i>
              项目管理
            </a>
          </div>
          
          <!-- 报名状态 -->
          <div class="mt-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">
            <h3 class="text-sm font-semibold text-green-800 mb-2">最新报名状态</h3>
            <div id="application-status" class="text-sm">
              <!-- 报名状态将在这里显示 -->
            </div>
          </div>
        </div>

        <!-- 统计信息卡片 -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 card-shadow border border-white/20">
          <h2 class="text-lg font-semibold mb-6 flex items-center text-primary">
            <i class="fas fa-trophy mr-2"></i>
            我的统计
          </h2>
          <div id="statistics-content" class="space-y-4">
            <!-- 加载中状态 -->
            <div class="flex items-center justify-center py-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
              <span class="ml-3 text-gray-600">加载统计数据...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧主要内容区域 -->
      <div class="xl:col-span-3 space-y-6">
        
        <!-- 标签页导航 -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-2 card-shadow border border-white/20">
          <div class="flex space-x-1" role="tablist">
            <button class="tab-btn active flex-1 py-3 px-4 rounded-xl text-sm font-medium transition-all duration-200" data-tab="profile">
              <i class="fas fa-user-edit mr-2"></i>
              个人信息
            </button>
            <button class="tab-btn flex-1 py-3 px-4 rounded-xl text-sm font-medium transition-all duration-200" data-tab="invitations">
              <i class="fas fa-key mr-2"></i>
              邀请码
            </button>
            <button class="tab-btn flex-1 py-3 px-4 rounded-xl text-sm font-medium transition-all duration-200" data-tab="security">
              <i class="fas fa-shield-alt mr-2"></i>
              安全设置
            </button>
          </div>
        </div>

        <!-- 个人信息标签页 -->
        <div id="profile-tab" class="tab-content active">
          <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-8 card-shadow border border-white/20">
            <h2 class="text-2xl font-semibold mb-6 flex items-center text-primary">
              <i class="fas fa-user-edit mr-3"></i>
              完善个人信息
            </h2>
            <form class="space-y-6" id="profileForm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="name">
                    姓名 <span class="text-red-500">*</span>
                  </label>
                  <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="name" name="name" placeholder="请输入您的姓名" type="text"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="studentId">
                    学号 <span class="text-red-500">*</span>
                  </label>
                  <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="studentId" name="studentId" placeholder="请输入您的学号" type="text"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="major">
                    专业 <span class="text-red-500">*</span>
                  </label>
                  <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="major" name="major" placeholder="请输入您的专业" type="text"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="grade">
                    年级 <span class="text-red-500">*</span>
                  </label>
                  <select class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="grade" name="grade">
                    <option value="">请选择年级</option>
                    <option value="freshman">大一</option>
                    <option value="sophomore">大二</option>
                    <option value="junior">大三</option>
                    <option value="senior">大四</option>
                    <option value="graduate">研究生</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="email">
                    邮箱 <span class="text-red-500">*</span>
                  </label>
                  <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="email" name="email" placeholder="请输入您的邮箱" type="email"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="phone">
                    手机号 <span class="text-red-500">*</span>
                  </label>
                  <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="phone" name="phone" placeholder="请输入您的手机号" type="tel"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="birthday">
                    生日 <span class="text-red-500">*</span>
                  </label>
                  <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="birthday" name="birthday" type="date"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="qq">
                    QQ号
                  </label>
                  <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="qq" name="qq" placeholder="请输入您的QQ号" type="text"/>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="introduction">
                  个人简介 <span class="text-red-500">*</span>
                </label>
                <textarea class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="introduction" name="introduction" placeholder="请简要介绍一下自己，兴趣爱好、技术特长等..." rows="4"></textarea>
                <p class="text-xs text-secondary mt-2">
                  最多输入200个字
                </p>
              </div>
              <div class="flex justify-end pt-4">
                <button class="btn-primary px-8 py-3 rounded-lg text-base font-medium" type="submit">
                  <i class="fas fa-save mr-2"></i>
                  保存信息
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- 邀请码标签页 -->
        <div id="invitations-tab" class="tab-content hidden">
          <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-8 card-shadow border border-white/20">
            <h2 class="text-2xl font-semibold mb-6 flex items-center text-warning">
              <i class="fas fa-key mr-3"></i>
              邀请码管理
            </h2>
            <div id="invitation-notifications" class="space-y-4">
              <!-- 邀请码通知将在这里动态显示 -->
              <div class="text-center py-12">
                <div class="text-gray-400 mb-4">
                  <i class="fas fa-search text-4xl"></i>
                </div>
                <p class="text-gray-600 text-lg">加载中...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 安全设置标签页 -->
        <div id="security-tab" class="tab-content hidden">
          <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-8 card-shadow border border-white/20">
            <h2 class="text-2xl font-semibold mb-6 flex items-center text-danger">
              <i class="fas fa-shield-alt mr-3"></i>
              安全设置
            </h2>
            <form class="space-y-6" id="passwordForm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="oldPassword">
                    原密码
                  </label>
                  <div class="relative">
                    <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="oldPassword" name="oldPassword" placeholder="请输入原密码" type="password"/>
                    <button class="toggle-password absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary" data-target="oldPassword" type="button">
                      <i class="fas fa-eye-slash"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="newPassword">
                    新密码
                  </label>
                  <div class="relative">
                    <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="newPassword" name="newPassword" placeholder="请输入新密码" type="password"/>
                    <button class="toggle-password absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary" data-target="newPassword" type="button">
                      <i class="fas fa-eye-slash"></i>
                    </button>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2" for="confirmPassword">
                    确认新密码
                  </label>
                  <div class="relative">
                    <input class="w-full px-4 py-3 border border-gray-300 rounded-lg form-input-focus" id="confirmPassword" name="confirmPassword" placeholder="请再次输入新密码" type="password"/>
                    <button class="toggle-password absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary" data-target="confirmPassword" type="button">
                      <i class="fas fa-eye-slash"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="flex justify-end pt-4">
                <button class="btn-primary px-8 py-3 rounded-lg text-base font-medium" type="submit">
                  <i class="fas fa-key mr-2"></i>
                  修改密码
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 成功提示模态框 -->
  <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
      <div class="text-success text-4xl mb-4">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3 class="text-xl font-semibold mb-2">操作成功</h3>
      <p id="successMessage" class="text-secondary mb-6">信息已保存</p>
      <button onclick="closeSuccessModal()" class="btn-primary px-6 py-2 rounded-lg">
        确定
      </button>
    </div>
  </div>

  <!-- 消息提示框 -->
  <div class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 flex items-center z-50" id="toast">
   <i class="mr-2" id="toastIcon">
   </i>
   <span id="toastMessage">
    提示消息
   </span>
  </div>
  <script>
   // 全局变量
   let currentUser = null;

   // 页面加载时初始化
   document.addEventListener('DOMContentLoaded', function() {
     console.log('个人中心页面加载完成');
     checkAuthStatus();
     initPasswordToggle();
     initFormSubmissions();
     initAvatarUpload();
     initQuickActions();
     initTabSwitch(); // 初始化标签页切换
   });

   // 检查认证状态
   async function checkAuthStatus() {
     try {
       console.log('检查认证状态...');
       const { data: { user }, error: userError } = await window.supabase.auth.getUser();
       
       if (userError) {
         console.error('获取用户信息失败:', userError);
         showToast('认证失败，请重新登录', 'error');
         setTimeout(() => {
           window.location.href = './index.html';
         }, 2000);
         return;
       }
       
       if (user) {
         console.log('用户已登录:', user.email);
         currentUser = user;
               loadUserProfile();
      loadApplicationStatus();
      loadUserStatistics();
       } else {
         console.log('用户未登录，跳转到首页');
         showToast('请先登录', 'error');
         setTimeout(() => {
           window.location.href = './index.html';
         }, 2000);
       }
     } catch (error) {
       console.error('检查认证状态失败:', error);
       showToast('认证检查失败，请重新登录', 'error');
       setTimeout(() => {
         window.location.href = './index.html';
       }, 2000);
     }
   }

   // 初始化密码显示/隐藏切换
   function initPasswordToggle() {
     const toggleButtons = document.querySelectorAll('.toggle-password');
     toggleButtons.forEach(function(button) {
       button.addEventListener('click', function() {
         const targetId = button.getAttribute('data-target');
         const passwordInput = document.getElementById(targetId);
         const icon = button.querySelector('i');
         if (passwordInput.type === 'password') {
           passwordInput.type = 'text';
           icon.classList.remove('fa-eye-slash');
           icon.classList.add('fa-eye');
         } else {
           passwordInput.type = 'password';
           icon.classList.remove('fa-eye');
           icon.classList.add('fa-eye-slash');
         }
       });
     });
   }

   // 初始化表单提交事件
   function initFormSubmissions() {
     // 个人信息表单提交
     const profileForm = document.getElementById('profileForm');
     profileForm.addEventListener('submit', function(e) {
       e.preventDefault();
       saveUserProfile();
     });

     // 密码修改表单提交
     const passwordForm = document.getElementById('passwordForm');
     passwordForm.addEventListener('submit', function(e) {
       e.preventDefault();
       changePassword();
     });
   }

   // 初始化头像上传
   function initAvatarUpload() {
     const avatarUpload = document.getElementById('avatarUpload');
     const avatarPreview = document.getElementById('avatarPreview');
     
     avatarUpload.addEventListener('change', async function(e) {
       const file = e.target.files[0];
       if (file) {
         try {
           console.log('开始上传头像文件:', {
             fileName: file.name,
             fileSize: file.size,
             fileType: file.type
           });
           
           // 文件大小检查（5MB限制）
           if (file.size > 5 * 1024 * 1024) {
             showToast('头像文件大小不能超过5MB', 'error');
             return;
           }
           
           // 文件类型检查
           if (!file.type.startsWith('image/')) {
             showToast('请选择图片文件', 'error');
             return;
           }
           
           // 生成安全的文件名
           const fileExt = file.name.split('.').pop().toLowerCase();
           const timestamp = Date.now();
           const fileName = `avatar_${currentUser.id}_${timestamp}.${fileExt}`;
           const filePath = `avatars/${fileName}`;
           
           console.log('准备上传到路径:', filePath);
           
           // 上传到 Supabase Storage
           const { data, error } = await window.supabase.storage
             .from('tyjk-files')
             .upload(filePath, file, { 
               upsert: true,
               cacheControl: '3600'
             });
           
           if (error) {
             console.error('文件上传失败:', error);
             console.error('错误详情:', {
               message: error.message,
               code: error.code,
               statusCode: error.statusCode,
               details: error.details
             });
             showToast('头像上传失败: ' + error.message, 'error');
             return;
           }
           
           console.log('文件上传成功:', data);
           
           // 获取公开URL
           const { data: urlData } = window.supabase.storage
             .from('tyjk-files')
             .getPublicUrl(filePath);
           
           console.log('获取到公开URL:', urlData.publicUrl);
           
           // 更新预览
           avatarPreview.src = urlData.publicUrl;
           
           // 更新页面上所有头像显示
           updateAvatarDisplay(urlData.publicUrl);
           
           showToast('头像上传成功', 'success');
           
           // 保存头像URL到用户信息
           await saveAvatarUrl(urlData.publicUrl);
         } catch (error) {
           console.error('头像上传过程发生异常:', error);
           console.error('异常详情:', {
             message: error.message,
             stack: error.stack,
             name: error.name
           });
           showToast('头像上传失败，请重试', 'error');
         }
       }
     });
   }

   // 更新头像显示
   function updateAvatarDisplay(avatarUrl) {
     console.log('开始更新头像显示:', avatarUrl);
     
     // 更新头像预览
     const avatarPreview = document.getElementById('avatarPreview');
     if (avatarPreview) {
       console.log('找到avatarPreview元素，更新src');
       avatarPreview.src = avatarUrl;
       avatarPreview.onload = function() {
         console.log('头像图片加载成功');
       };
       avatarPreview.onerror = function() {
         console.error('头像图片加载失败:', avatarUrl);
       };
     } else {
       console.error('未找到avatarPreview元素');
     }
     
     // 更新所有头像元素（如果有其他头像显示）
     const avatarElements = document.querySelectorAll('.avatar-image, .user-avatar, #avatarPreview');
     console.log('找到头像元素数量:', avatarElements.length);
     avatarElements.forEach((element, index) => {
       console.log(`更新头像元素 ${index}:`, element.id || element.className);
       element.src = avatarUrl;
       element.style.display = 'block';
     });
     
     // 隐藏默认头像占位符（如果有）
     const placeholderElements = document.querySelectorAll('.avatar-placeholder');
     placeholderElements.forEach(element => {
       element.style.display = 'none';
     });
     
     console.log('头像显示已更新:', avatarUrl);
   }

   // 初始化快捷操作按钮
   function initQuickActions() {
     // 退出登录按钮
     const logoutBtn = document.getElementById('logoutBtn');
     logoutBtn.addEventListener('click', async function() {
       if (confirm('确定要退出登录吗？')) {
         try {
           await window.supabase.auth.signOut();
           showToast('已退出登录', 'success');
           setTimeout(() => {
             window.location.href = './index.html';
           }, 1000);
         } catch (error) {
           console.error('退出登录失败:', error);
           showToast('退出登录失败', 'error');
         }
       }
     });
   }

   // 加载用户个人资料
   async function loadUserProfile() {
     try {
       console.log('加载用户信息...');
       const userName = currentUser.user_metadata?.name || '';
       const userEmail = currentUser.email || '';
       
       document.getElementById('user-name').textContent = userName || userEmail;
       document.getElementById('userName').textContent = userName || '未设置';
       document.getElementById('name').value = userName;
       document.getElementById('email').value = userEmail;
       
       // 加载详细信息
       const { data: profile, error } = await window.supabase
         .from('user_profiles')
         .select('*')
         .eq('user_id', currentUser.id)
         .single();
       
       if (profile) {
         console.log('找到用户详细信息:', profile);
         fillProfileForm(profile);
         
         // 如果有头像URL，显示头像
         if (profile.avatar_url) {
           updateAvatarDisplay(profile.avatar_url);
         }
       } else {
         console.log('未找到用户详细信息，使用默认值');
       }
       
       // 加载邀请码通知
       await loadInvitationNotifications();
     } catch (error) {
       console.error('加载用户信息失败:', error);
     }
   }

   // 填充表单数据
   function fillProfileForm(profile) {
     document.getElementById('studentId').value = profile.student_id || '';
     document.getElementById('major').value = profile.major || '';
     document.getElementById('grade').value = profile.grade || '';
     document.getElementById('phone').value = profile.phone || '';
     document.getElementById('birthday').value = profile.birthday || '';
     document.getElementById('qq').value = profile.qq || '';
     document.getElementById('introduction').value = profile.introduction || '';
     
     // 更新头像显示
     if (profile.avatar_url) {
       updateAvatarDisplay(profile.avatar_url);
     }
     
     // 更新用户信息显示
     updateUserInfoDisplay(profile);
   }

   // 更新用户信息显示
   function updateUserInfoDisplay(profile) {
     const userNameElement = document.getElementById('userName');
     const userInfoElement = document.getElementById('userInfo');
     
     if (profile.name) {
       userNameElement.textContent = profile.name;
       
       // 构建用户信息文本
       const userInfoText = [];
       if (profile.student_id) userInfoText.push(profile.student_id);
       if (profile.major) userInfoText.push(profile.major);
       if (profile.grade) userInfoText.push(profile.grade);
       
       userInfoElement.textContent = userInfoText.join(' | ') || '个人信息已完善';
     }
   }

   // 保存用户个人资料
   async function saveUserProfile() {
     try {
       const userProfile = {
         user_id: currentUser.id,
         name: document.getElementById('name').value.trim(),
         student_id: document.getElementById('studentId').value.trim(),
         major: document.getElementById('major').value.trim(),
         grade: document.getElementById('grade').value,
         email: document.getElementById('email').value.trim(),
         phone: document.getElementById('phone').value.trim(),
         birthday: document.getElementById('birthday').value,
         qq: document.getElementById('qq').value.trim(),
         introduction: document.getElementById('introduction').value.trim(),
         updated_at: new Date().toISOString()
       };

       // 简单验证
       if (!userProfile.name) {
         showToast('请输入姓名', 'error');
         return;
       }

       // 保存到 Supabase
       // 先检查是否已存在记录
       const { data: existingProfile } = await window.supabase
         .from('user_profiles')
         .select('id')
         .eq('user_id', currentUser.id)
         .single();

       let error;
       if (existingProfile) {
         // 更新现有记录
         const { error: updateError } = await window.supabase
           .from('user_profiles')
           .update(userProfile)
           .eq('user_id', currentUser.id);
         error = updateError;
       } else {
         // 插入新记录
         const { error: insertError } = await window.supabase
           .from('user_profiles')
           .insert(userProfile);
         error = insertError;
       }

       if (error) {
         console.error('保存用户信息失败:', error);
         showToast('保存失败: ' + error.message, 'error');
       } else {
         showToast('个人信息保存成功', 'success');
         updateUserInfoDisplay(userProfile);
       }
     } catch (error) {
       console.error('保存用户信息失败:', error);
       showToast('保存失败，请稍后重试', 'error');
     }
   }

   // 保存头像URL
   async function saveAvatarUrl(avatarUrl) {
     try {
       console.log('保存头像URL:', avatarUrl);
       
       // 先检查是否已存在记录
       const { data: existingProfile } = await window.supabase
         .from('user_profiles')
         .select('id')
         .eq('user_id', currentUser.id)
         .single();

       let error;
       if (existingProfile) {
         // 更新现有记录
         const { error: updateError } = await window.supabase
           .from('user_profiles')
           .update({
             avatar_url: avatarUrl,
             updated_at: new Date().toISOString()
           })
           .eq('user_id', currentUser.id);
         error = updateError;
       } else {
         // 插入新记录
         const { error: insertError } = await window.supabase
           .from('user_profiles')
           .insert({
             user_id: currentUser.id,
             avatar_url: avatarUrl,
             updated_at: new Date().toISOString()
           });
         error = insertError;
       }

       if (error) {
         console.error('保存头像URL失败:', error);
         showToast('头像保存失败', 'error');
       } else {
         console.log('头像URL保存成功');
         showToast('头像保存成功', 'success');
       }
     } catch (error) {
       console.error('保存头像URL失败:', error);
       showToast('头像保存失败', 'error');
     }
   }

   // 修改密码
   async function changePassword() {
     const oldPassword = document.getElementById('oldPassword').value;
     const newPassword = document.getElementById('newPassword').value;
     const confirmPassword = document.getElementById('confirmPassword').value;

     // 简单验证
     if (!oldPassword) {
       showToast('请输入原密码', 'error');
       return;
     }
     if (!newPassword) {
       showToast('请输入新密码', 'error');
       return;
     }
     if (newPassword !== confirmPassword) {
       showToast('两次输入的新密码不一致', 'error');
       return;
     }
     if (newPassword.length < 6) {
       showToast('新密码长度不能少于6位', 'error');
       return;
     }

     try {
       // 先用旧密码登录验证
       const { error: signInError } = await window.supabase.auth.signInWithPassword({
         email: currentUser.email,
         password: oldPassword
       });
       
       if (signInError) {
         showToast('原密码错误', 'error');
         return;
       }

       // 修改密码
       const { error } = await window.supabase.auth.updateUser({ password: newPassword });
       
       if (error) {
         showToast('修改密码失败: ' + error.message, 'error');
       } else {
         showToast('密码修改成功，请重新登录', 'success');
         
         // 重置密码表单
         document.getElementById('passwordForm').reset();
         
         // 2秒后自动退出登录
         setTimeout(async function() {
           await window.supabase.auth.signOut();
           window.location.href = './index.html';
         }, 2000);
       }
     } catch (error) {
       console.error('修改密码失败:', error);
       showToast('修改密码失败，请稍后重试', 'error');
     }
   }

   // 加载报名状态
   async function loadApplicationStatus() {
     try {
       console.log('加载报名状态...');
       
       // 从applications表获取报名记录
       console.log('从applications表获取数据...');
       const { data: applications, error: applicationsError } = await window.supabase
         .from('applications')
         .select('*')
         .eq('email', currentUser.email)
         .order('created_at', { ascending: false });
       
       console.log('applications表查询结果:', { data: applications, error: applicationsError });
       
       if (applicationsError) {
         console.error('加载applications表数据失败:', applicationsError);
         throw applicationsError;
       }
       
       const container = document.getElementById('application-status');
       
       // 显示applications表的数据
       if (applications && applications.length > 0) {
         console.log('显示applications表数据');
         const latest = applications[0];
         const statusText = getStatusText(latest.status);
         const statusColor = getStatusColor(latest.status);
         
         container.innerHTML = `
           <div class="text-sm">
             <div class="flex justify-between items-center mb-2">
               <span class="font-medium">最新报名</span>
               <span class="px-2 py-1 rounded-full text-xs ${statusColor}">${statusText}</span>
             </div>
             <div class="text-gray-600">
               <div>部门：${latest.department}</div>
               <div>时间：${new Date(latest.created_at).toLocaleDateString()}</div>
             </div>
           </div>
         `;
       } else {
         console.log('没有任何报名记录');
         // 没有任何报名记录
         container.innerHTML = `
           <div class="text-center py-4">
             <p class="text-gray-600 mb-2">您还没有提交过报名申请</p>
             <a href="./index.html#join" class="text-primary hover:underline">立即报名</a>
           </div>
         `;
       }
     } catch (error) {
       console.error('加载报名状态失败:', error);
       const container = document.getElementById('application-status');
       container.innerHTML = `
         <div class="text-center py-4">
           <p class="text-red-600 mb-2">加载失败，请稍后重试</p>
           <p class="text-xs text-gray-500">错误信息: ${error.message}</p>
         </div>
       `;
     }
   }

   function getStatusText(status) {
     const statusMap = {
       pending: '待审核',
       approved: '已通过',
       rejected: '已拒绝'
     };
     return statusMap[status] || status;
   }

   function getStatusColor(status) {
     const colorMap = {
       pending: 'bg-yellow-100 text-yellow-800',
       approved: 'bg-green-100 text-green-800',
       rejected: 'bg-red-100 text-red-800'
     };
     return colorMap[status] || 'bg-gray-100 text-gray-800';
   }

   // 加载邀请码通知
   async function loadInvitationNotifications() {
     try {
       console.log('加载邀请码通知...');
       const container = document.getElementById('invitation-notifications');
       
       // 获取用户的邀请码
       const { data: invitations, error } = await window.supabase
         .from('user_invitation_codes')
         .select('*')
         .eq('user_id', currentUser.id)
         .order('created_at', { ascending: false });
       
       if (error) {
         console.error('加载邀请码失败:', error);
         container.innerHTML = `
           <div class="text-center py-4">
             <div class="text-red-400 mb-2">
               <i class="fas fa-exclamation-circle text-xl"></i>
             </div>
             <p class="text-gray-600">加载失败，请稍后重试</p>
           </div>
         `;
         return;
       }
       
       if (!invitations || invitations.length === 0) {
         // 没有邀请码
         container.innerHTML = `
           <div class="text-center py-6">
             <div class="text-gray-400 mb-3">
               <i class="fas fa-search text-3xl"></i>
             </div>
             <p class="text-gray-600 mb-2">暂无邀请码通知</p>
             <p class="text-sm text-gray-500">当管理员为您生成邀请码时，您将在这里收到通知</p>
             <div class="mt-4 space-x-2">
               <button onclick="loadInvitationNotifications()" class="text-primary hover:underline text-sm">
                 <i class="fas fa-refresh mr-1"></i>刷新
               </button>
               <button onclick="contactAdmin()" class="text-primary hover:underline text-sm">
                 <i class="fas fa-envelope mr-1"></i>联系管理员
               </button>
             </div>
           </div>
         `;
         return;
       }
       
       // 显示邀请码通知
       const invitation = invitations[0]; // 显示最新的邀请码
                   const isExpired = new Date(invitation.expires_at) < new Date();
            const expiresInDays = Math.ceil((new Date(invitation.expires_at) - new Date()) / (1000 * 60 * 60 * 24));
            const isExpiringSoon = expiresInDays <= 1 && expiresInDays > 0; // 调整为1天内即将过期
       
       let notificationHtml = '';
       
       if (isExpired) {
         // 已过期的邀请码
         notificationHtml = `
           <div class="border border-red-200 bg-red-50 rounded-lg p-4">
             <div class="flex items-start justify-between mb-3">
               <div class="flex items-center">
                 <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                 <span class="font-semibold text-red-700">邀请码已过期</span>
               </div>
               <span class="text-xs text-gray-500">${new Date(invitation.created_at).toLocaleDateString()}</span>
             </div>
             <div class="bg-white border border-red-200 rounded p-3 mb-3">
               <div class="flex items-center justify-between">
                 <span class="font-mono text-lg">${invitation.invitation_code}</span>
                 <span class="text-red-500 text-sm">(已过期)</span>
               </div>
             </div>
             <div class="text-sm text-gray-600 mb-3">
               <div>📅 过期时间: ${new Date(invitation.expires_at).toLocaleDateString()}</div>
               <div>💡 如需继续使用，请联系管理员申请新的邀请码</div>
             </div>
             <div class="flex space-x-2">
               <button onclick="contactAdmin()" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600 transition-colors">
                 <i class="fas fa-envelope mr-1"></i>联系管理员
               </button>
               <button onclick="requestNewInvitation()" class="bg-orange-500 text-white px-3 py-1 rounded text-sm hover:bg-orange-600 transition-colors">
                 <i class="fas fa-plus mr-1"></i>申请新邀请码
               </button>
             </div>
           </div>
         `;
       } else if (isExpiringSoon) {
         // 即将过期的邀请码
         notificationHtml = `
           <div class="border border-yellow-200 bg-yellow-50 rounded-lg p-4">
             <div class="flex items-start justify-between mb-3">
               <div class="flex items-center">
                 <i class="fas fa-clock text-yellow-600 mr-2"></i>
                 <span class="font-semibold text-yellow-700">邀请码即将过期</span>
               </div>
               <span class="text-xs text-gray-500">${new Date(invitation.created_at).toLocaleDateString()}</span>
             </div>
             <div class="bg-white border border-yellow-200 rounded p-3 mb-3">
               <div class="flex items-center justify-between">
                 <span class="font-mono text-lg">${invitation.invitation_code}</span>
                 <button onclick="copyInvitationCode('${invitation.invitation_code}')" class="text-blue-500 hover:text-blue-700 text-sm">
                   <i class="fas fa-copy mr-1"></i>复制
                 </button>
               </div>
             </div>
             <div class="text-sm text-gray-600 mb-3">
               <div>📅 过期时间: ${new Date(invitation.expires_at).toLocaleDateString()}</div>
               <div>⏰ 剩余时间: ${expiresInDays}天</div>
             </div>
             <div class="flex space-x-2">
               <button onclick="useInvitationCode()" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors">
                 <i class="fas fa-arrow-right mr-1"></i>立即使用
               </button>
               <button onclick="requestExtension()" class="bg-yellow-500 text-black px-3 py-1 rounded text-sm hover:bg-yellow-600 transition-colors">
                 <i class="fas fa-clock mr-1"></i>申请延期
               </button>
             </div>
           </div>
         `;
       } else {
         // 有效的邀请码
         notificationHtml = `
           <div class="border border-green-200 bg-green-50 rounded-lg p-4">
             <div class="flex items-start justify-between mb-3">
               <div class="flex items-center">
                 <i class="fas fa-check-circle text-green-500 mr-2"></i>
                 <span class="font-semibold text-green-700">项目管理邀请码</span>
               </div>
               <span class="text-xs text-gray-500">${new Date(invitation.created_at).toLocaleDateString()}</span>
             </div>
             <div class="bg-white border border-green-200 rounded p-3 mb-3">
               <div class="flex items-center justify-between">
                 <span class="font-mono text-lg">${invitation.invitation_code}</span>
                 <button onclick="copyInvitationCode('${invitation.invitation_code}')" class="text-blue-500 hover:text-blue-700 text-sm">
                   <i class="fas fa-copy mr-1"></i>复制
                 </button>
               </div>
             </div>
             <div class="text-sm text-gray-600 mb-3">
               <div>📅 有效期至: ${new Date(invitation.expires_at).toLocaleDateString()}</div>
               <div>🎯 权限范围: 项目管理功能</div>
             </div>
             <div class="flex space-x-2">
               <button onclick="useInvitationCode()" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors">
                 <i class="fas fa-arrow-right mr-1"></i>立即使用
               </button>
               <button onclick="viewLater()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition-colors">
                 <i class="fas fa-eye mr-1"></i>稍后查看
               </button>
             </div>
           </div>
         `;
       }
       
       container.innerHTML = notificationHtml;
       
     } catch (error) {
       console.error('加载邀请码通知失败:', error);
       const container = document.getElementById('invitation-notifications');
       container.innerHTML = `
         <div class="text-center py-4">
           <div class="text-red-400 mb-2">
             <i class="fas fa-exclamation-circle text-xl"></i>
           </div>
           <p class="text-gray-600">加载失败，请稍后重试</p>
         </div>
       `;
     }
   }

   // 复制邀请码
   async function copyInvitationCode(code) {
     try {
       await navigator.clipboard.writeText(code);
       showToast('邀请码已复制到剪贴板', 'success');
     } catch (error) {
       console.error('复制失败:', error);
       showToast('复制失败，请手动复制', 'error');
     }
   }

   // 使用邀请码（跳转到项目管理页面）
   function useInvitationCode() {
     showToast('正在跳转到项目管理页面...', 'info');
     setTimeout(() => {
       // 直接跳转到项目管理页面
       window.location.href = './project-management.html';
     }, 1000);
   }

   // 稍后查看
   function viewLater() {
     showToast('您可以在需要时随时使用邀请码', 'info');
   }

   // 申请延期
   function requestExtension() {
     showToast('延期申请已发送给管理员', 'info');
   }

   // 申请新邀请码
   function requestNewInvitation() {
     showToast('新邀请码申请已发送给管理员', 'info');
   }

   // 联系管理员
   function contactAdmin() {
     showContactAdminModal();
   }

   // 标签页切换功能
   function initTabSwitch() {
     const tabBtns = document.querySelectorAll('.tab-btn');
     const tabContents = document.querySelectorAll('.tab-content');

     tabBtns.forEach(btn => {
       btn.addEventListener('click', function() {
         const targetTab = this.getAttribute('data-tab');
         
         // 移除所有活动状态
         tabBtns.forEach(b => b.classList.remove('active', 'bg-primary', 'text-white'));
         tabContents.forEach(c => c.classList.add('hidden'));
         
         // 添加活动状态
         this.classList.add('active', 'bg-primary', 'text-white');
         document.getElementById(targetTab + '-tab').classList.remove('hidden');
       });
     });
   }

   // 显示提示消息
   function showToast(message, type = 'info') {
     const toast = document.getElementById('toast');
     const toastMessage = document.getElementById('toastMessage');
     const toastIcon = document.getElementById('toastIcon');

     // 设置消息内容
     toastMessage.textContent = message;

     // 设置图标和样式
     toastIcon.className = '';
     toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 flex items-center z-50';
     
     switch (type) {
       case 'success':
         toast.classList.add('bg-green-500', 'text-white');
         toastIcon.classList.add('fas', 'fa-check-circle');
         break;
       case 'error':
         toast.classList.add('bg-red-500', 'text-white');
         toastIcon.classList.add('fas', 'fa-exclamation-circle');
         break;
       case 'warning':
         toast.classList.add('bg-yellow-500', 'text-white');
         toastIcon.classList.add('fas', 'fa-exclamation-triangle');
         break;
       case 'info':
       default:
         toast.classList.add('bg-blue-500', 'text-white');
         toastIcon.classList.add('fas', 'fa-info-circle');
         break;
     }

     // 显示提示框
     toast.classList.remove('translate-x-full');
     toast.classList.add('translate-x-0');

     // 3秒后自动隐藏
     setTimeout(function() {
       toast.classList.remove('translate-x-0');
       toast.classList.add('translate-x-full');
     }, 3000);
   }

   // 关闭成功模态框
   window.closeSuccessModal = function() {
     document.getElementById('successModal').classList.add('hidden');
   };

   // 显示成功模态框
   function showSuccessModal(message) {
     document.getElementById('successMessage').textContent = message;
     document.getElementById('successModal').classList.remove('hidden');
   }

   // 填充个人信息表单
   function fillProfileForm(profile) {
     document.getElementById('studentId').value = profile.student_id || '';
     document.getElementById('major').value = profile.major || '';
     document.getElementById('grade').value = profile.grade || '';
     document.getElementById('phone').value = profile.phone || '';
     document.getElementById('birthday').value = profile.birthday || '';
     document.getElementById('qq').value = profile.qq || '';
     document.getElementById('introduction').value = profile.introduction || '';
   }

   // 保存用户个人信息
   async function saveUserProfile() {
     try {
       const formData = new FormData(document.getElementById('profileForm'));
       const profileData = {
         user_id: currentUser.id,
         name: formData.get('name'),
         student_id: formData.get('studentId'),
         major: formData.get('major'),
         grade: formData.get('grade'),
         email: formData.get('email'),
         phone: formData.get('phone'),
         birthday: formData.get('birthday'),
         qq: formData.get('qq'),
         introduction: formData.get('introduction'),
         updated_at: new Date().toISOString()
       };

       const { data, error } = await window.supabase
         .from('user_profiles')
         .upsert(profileData, { onConflict: 'user_id' });

       if (error) {
         console.error('保存个人信息失败:', error);
         showToast('保存失败: ' + error.message, 'error');
         return;
       }

       showSuccessModal('个人信息保存成功！');
       showToast('个人信息已保存', 'success');
       
       // 更新页面显示
       document.getElementById('userName').textContent = profileData.name || '未设置';
       document.getElementById('user-name').textContent = profileData.name || currentUser.email;
       
       // 刷新统计数据
       await loadUserStatistics();
       
     } catch (error) {
       console.error('保存个人信息失败:', error);
       showToast('保存失败，请稍后重试', 'error');
     }
   }

   // 修改密码
   async function changePassword() {
     try {
       const oldPassword = document.getElementById('oldPassword').value;
       const newPassword = document.getElementById('newPassword').value;
       const confirmPassword = document.getElementById('confirmPassword').value;

       if (!oldPassword || !newPassword || !confirmPassword) {
         showToast('请填写所有密码字段', 'error');
         return;
       }

       if (newPassword !== confirmPassword) {
         showToast('新密码与确认密码不一致', 'error');
         return;
       }

       if (newPassword.length < 6) {
         showToast('新密码长度至少6位', 'error');
         return;
       }

       const { error } = await window.supabase.auth.updateUser({
         password: newPassword
       });

       if (error) {
         console.error('修改密码失败:', error);
         showToast('修改密码失败: ' + error.message, 'error');
         return;
       }

       showSuccessModal('密码修改成功！');
       showToast('密码已修改', 'success');
       
       // 清空表单
       document.getElementById('passwordForm').reset();
       
     } catch (error) {
       console.error('修改密码失败:', error);
       showToast('修改密码失败，请稍后重试', 'error');
     }
   }

   // 保存头像URL
   async function saveAvatarUrl(avatarUrl) {
     try {
       const { error } = await window.supabase
         .from('user_profiles')
         .upsert({
           user_id: currentUser.id,
           avatar_url: avatarUrl,
           updated_at: new Date().toISOString()
         }, { onConflict: 'user_id' });

       if (error) {
         console.error('保存头像URL失败:', error);
       }
     } catch (error) {
       console.error('保存头像URL失败:', error);
     }
   }



    // 加载用户统计数据
    async function loadUserStatistics() {
      try {
        console.log('加载用户统计数据...');
        
        // 获取用户参与的项目数量
        const { data: userProjects, error: projectsError } = await window.supabase
          .from('project_members')
          .select('project_id')
          .eq('user_id', currentUser.id)
          .eq('status', 'active');

        if (projectsError) {
          console.error('加载用户项目失败:', projectsError);
          displayStatistics({
            total_projects: 0,
            national_awards: 0,
            provincial_awards: 0,
            school_awards: 0,
            other_awards: 0
          });
          return;
        }

        const projectIds = userProjects.map(p => p.project_id);
        console.log('用户参与的项目ID:', projectIds);

        // 获取用户参与的项目中申请了奖项的项目
        const { data: awardProjects, error: awardError } = await window.supabase
          .from('projects')
          .select('award_level')
          .in('id', projectIds)
          .not('award_level', 'is', null);

        if (awardError) {
          console.error('加载奖项数据失败:', awardError);
          displayStatistics({
            total_projects: projectIds.length,
            national_awards: 0,
            provincial_awards: 0,
            school_awards: 0,
            other_awards: 0
          });
          return;
        }

        console.log('获取到的奖项数据:', awardProjects);

        // 计算统计数据
        const stats = {
          total_projects: projectIds.length,
          national_awards: awardProjects.filter(p => p.award_level === 'national').length,
          provincial_awards: awardProjects.filter(p => p.award_level === 'provincial').length,
          school_awards: awardProjects.filter(p => p.award_level === 'school').length,
          other_awards: awardProjects.filter(p => p.award_level === 'other').length
        };

        console.log('计算得出的统计数据:', stats);
        displayStatistics(stats);

      } catch (error) {
        console.error('加载统计数据失败:', error);
        // 显示默认数据
        displayStatistics({
          total_projects: 0,
          national_awards: 0,
          provincial_awards: 0,
          school_awards: 0,
          other_awards: 0
        });
      }
    }

    // 显示统计数据
    function displayStatistics(stats) {
      const container = document.getElementById('statistics-content');
      
      container.innerHTML = `
        <!-- 参与项目 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
          <div class="flex items-center">
            <i class="fas fa-project-diagram text-blue-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">参与项目</span>
          </div>
          <span class="text-xl font-bold text-blue-600">${stats.total_projects || 0}</span>
        </div>
        
        <!-- 国家级奖项 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-lg border border-red-100">
          <div class="flex items-center">
            <i class="fas fa-crown text-red-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">国家级奖项</span>
          </div>
          <span class="text-xl font-bold text-red-600">${stats.national_awards || 0}</span>
        </div>
        
        <!-- 省级奖项 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-100">
          <div class="flex items-center">
            <i class="fas fa-medal text-blue-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">省级奖项</span>
          </div>
          <span class="text-xl font-bold text-blue-600">${stats.provincial_awards || 0}</span>
        </div>
        
        <!-- 校级奖项 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-100">
          <div class="flex items-center">
            <i class="fas fa-award text-green-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">校级奖项</span>
          </div>
          <span class="text-xl font-bold text-green-600">${stats.school_awards || 0}</span>
        </div>
        
        <!-- 其他奖项 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-violet-50 rounded-lg border border-purple-100">
          <div class="flex items-center">
            <i class="fas fa-star text-purple-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">其他奖项</span>
          </div>
          <span class="text-xl font-bold text-purple-600">${stats.other_awards || 0}</span>
        </div>
      `;
    }

    // 显示联系管理员模态框
    function showContactAdminModal() {
      document.getElementById('contact-admin-modal').classList.remove('hidden');
    }

    // 关闭联系管理员模态框
    function closeContactAdminModal() {
      document.getElementById('contact-admin-modal').classList.add('hidden');
    }

    // 复制邮箱到剪贴板
    function copyEmail() {
      const email = '767997302@qq.com';
      navigator.clipboard.writeText(email).then(function() {
        // 显示成功提示
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check mr-2"></i>已复制';
        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        button.classList.add('bg-green-600', 'hover:bg-green-700');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('bg-green-600', 'hover:bg-green-700');
          button.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);
      }).catch(function(err) {
        console.error('复制失败:', err);
        alert('复制失败，请手动复制邮箱地址');
      });
    }

    // 复制电话到剪贴板
    function copyPhone() {
      const phone = '18532206167';
      navigator.clipboard.writeText(phone).then(function() {
        // 显示成功提示
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check mr-2"></i>已复制';
        button.classList.remove('bg-green-600', 'hover:bg-green-700');
        button.classList.add('bg-blue-600', 'hover:bg-blue-700');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
          button.classList.add('bg-green-600', 'hover:bg-green-700');
        }, 2000);
      }).catch(function(err) {
        console.error('复制失败:', err);
        alert('复制失败，请手动复制电话号码');
      });
    }

    // 显示统计数据
    function displayStatistics(stats) {
      const container = document.getElementById('statistics-content');
      
      container.innerHTML = `
        <!-- 参与项目 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
          <div class="flex items-center">
            <i class="fas fa-project-diagram text-blue-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">参与项目</span>
          </div>
          <span class="text-xl font-bold text-blue-600">${stats.total_projects || 0}</span>
        </div>
        
        <!-- 国家级奖项 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-lg border border-red-100">
          <div class="flex items-center">
            <i class="fas fa-crown text-red-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">国家级奖项</span>
          </div>
          <span class="text-xl font-bold text-red-600">${stats.national_awards || 0}</span>
        </div>
        
        <!-- 省级奖项 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-100">
          <div class="flex items-center">
            <i class="fas fa-medal text-blue-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">省级奖项</span>
          </div>
          <span class="text-xl font-bold text-blue-600">${stats.provincial_awards || 0}</span>
        </div>
        
        <!-- 校级奖项 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-100">
          <div class="flex items-center">
            <i class="fas fa-award text-green-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">校级奖项</span>
          </div>
          <span class="text-xl font-bold text-green-600">${stats.school_awards || 0}</span>
        </div>
        
        <!-- 其他奖项 -->
        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-violet-50 rounded-lg border border-purple-100">
          <div class="flex items-center">
            <i class="fas fa-star text-purple-600 mr-3 text-lg"></i>
            <span class="text-sm font-medium text-gray-700">其他奖项</span>
          </div>
          <span class="text-xl font-bold text-purple-600">${stats.other_awards || 0}</span>
        </div>
      `;
    }

    // 刷新统计数据
    async function refreshStatistics() {
      try {
        // 显示加载状态
        const container = document.getElementById('statistics-content');
        container.innerHTML = `
          <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <span class="ml-3 text-gray-600">刷新统计数据...</span>
          </div>
        `;
        
        // 重新加载统计数据
        await loadUserStatistics();
        
        // 显示成功提示
        showToast('统计数据已刷新', 'success');
      } catch (error) {
        console.error('刷新统计数据失败:', error);
        showToast('刷新失败，请重试', 'error');
      }
    }

    // 显示联系管理员模态框
    function showContactAdminModal() {
      document.getElementById('contact-admin-modal').classList.remove('hidden');
    }

    // 关闭联系管理员模态框
    function closeContactAdminModal() {
      document.getElementById('contact-admin-modal').classList.add('hidden');
    }

    // 将函数暴露到全局作用域
    window.refreshStatistics = refreshStatistics;
  </script>

  <!-- 联系管理员模态框 -->
  <div id="contact-admin-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-xl">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800">联系管理员</h3>
        <button onclick="closeContactAdminModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-headset text-white text-2xl"></i>
        </div>
        <h4 class="text-lg font-semibold text-gray-900 mb-2">需要帮助？</h4>
        <p class="text-gray-600">请联系管理员获取邀请码或解决其他问题</p>
      </div>

      <div class="space-y-4 mb-6">
        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
          <div class="flex items-center">
            <i class="fas fa-envelope text-blue-600 mr-3 text-lg"></i>
            <div>
              <p class="text-sm font-medium text-gray-700">邮箱联系</p>
              <p class="text-blue-600 font-semibold">767997302@qq.com</p>
            </div>
          </div>
        </div>
        
        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
          <div class="flex items-center">
            <i class="fas fa-phone text-green-600 mr-3 text-lg"></i>
            <div>
              <p class="text-sm font-medium text-gray-700">电话联系</p>
              <p class="text-green-600 font-semibold">18532206167</p>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200 mb-6">
        <div class="flex items-start">
          <i class="fas fa-info-circle text-yellow-600 mr-3 mt-1"></i>
          <div>
            <p class="text-sm font-medium text-gray-700 mb-1">温馨提示</p>
            <p class="text-sm text-gray-600">联系管理员时，请提供您的注册邮箱和姓名，以便快速处理您的请求。</p>
          </div>
        </div>
      </div>

      <div class="flex space-x-3">
        <button onclick="copyEmail()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
          <i class="fas fa-copy mr-2"></i>复制邮箱
        </button>
        <button onclick="copyPhone()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
          <i class="fas fa-phone mr-2"></i>复制电话
        </button>
      </div>

      <div class="mt-4 text-center">
        <button onclick="closeContactAdminModal()" class="text-gray-500 hover:text-gray-700 font-medium">
          关闭
        </button>
      </div>
    </div>
  </div>
 </body>
</html>
